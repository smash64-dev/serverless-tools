AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: A collection of serverless functions to aid smash64-dev

Parameters:
  ApiSubdomain:
    Type: String
    Default: api
  OnlineDomain:
    Type: String
    Default: smash64.online
  Prefix:
    Type: String
    Default: serverless-tools
  Stage:
    Type: String
    Default: prod

Globals:
  Api:
    OpenApiVersion: 3.0.3
  Function:
    Handler: app.lambda_handler
    Runtime: python3.9
    Timeout: 5
    Environment:
      Variables: {}

Resources:
  # api gateways
  OnlineDomainApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "${ApiSubdomain}.${OnlineDomain}"
      Description: !Sub "Public REST API for ${OnlineDomain}"
      StageName: !Sub "${Stage}"

  # domain mapping - domain creation is handled outside this stack configuration
  OnlineDomainApiMapping:
    Type: AWS::ApiGateway::BasePathMapping
    Properties:
      DomainName: !Sub "${ApiSubdomain}.${OnlineDomain}"
      RestApiId: !Ref OnlineDomainApi
      Stage: !Ref OnlineDomainApi.Stage

  # lambda layers
  KailleraPythonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub "${Prefix}-lib-kaillera-py"
      Description: Minimal library to communicate with kaillera servers and okai p2p clients
      ContentUri: lib/python
    Metadata:
      BuildMethod: python3.9

  # lambda functions
  KailleraServerCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Prefix}-kaillera-server-check"
      Description: Checks if a public kaillera server is running
      CodeUri: server-check/src/
      Layers:
        - !Ref KailleraPythonLayer
      Events:
        ServerCheck:
          Type: Api
          Properties:
            Path: /kaillera/server-check
            Method: POST
            RestApiId:
              Ref: OnlineDomainApi
